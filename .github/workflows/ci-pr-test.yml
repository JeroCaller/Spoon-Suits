name: CI Test on Pull Request

on:
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  pull-requests: write # PRì— ëŒ“ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”í•©ë‹ˆë‹¤.

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì¹˜
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Setup Gradle
        uses: actions/setup-gradle@v3

      # 4. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. Gradle í…ŒìŠ¤íŠ¸ ë° Jacoco ë¦¬í¬íŠ¸ ìƒì„±
      # spoonsuits-local-testì˜ testë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. build.gradle ì„¤ì •ì— ë”°ë¼ Jacoco ë¦¬í¬íŠ¸ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
      - name: Test with Gradle
        run: ./gradlew -PenableLocalTest=true :spoonsuits-local-test:test

      # 6. Jacoco ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë¥¼ PRì— ëŒ“ê¸€ë¡œ ê²Œì‹œ (ì»¤ë²„ë¦¬ì§€ ê°•ì œ ì¡°ê±´ ì—†ìŒ)
      - name: Add Jacoco coverage comment to PR
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/spoonsuits-local-test/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ“Š Code Coverage Report"

      # 7. í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ ìƒì„¸ ë¶„ì„ìš©)
      - name: Upload Test Report
        if: always() # í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: spoonsuits-local-test/build/reports/tests/test/

      # 8. Jacoco ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸(HTML) ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ìƒì„¸ ë¶„ì„ìš©)
      - name: Upload JaCoCo Coverage Report
        if: always() # í…ŒìŠ¤íŠ¸ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: spoonsuits-local-test/build/reports/jacoco/test/html/
